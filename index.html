<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta type="description" content="『ドラブラ2周年桜祭り』モザイクアート。ここに、かけがえのない思い出が集う。そしてーー、新たな出逢いが、ドラブラで始まる。" />
  <meta name="keywords"
    content="コード,ドラゴンブラッド,コード ドラゴンブラッド,ドラゴン,コード：ドラゴンブラッド,Dragon,コードドラゴン,ドラブラ,コードドラゴンブラッド,ブラッド,近未来RPG,龍族,MMORPG,codedblood,codedragonblood,2020の思い出" />

  <!-- twitter分享 -->
  <meta property="twitter:url" content="https://codedblood.jp/act/2020memo/index.html" />
  <meta name="twitter:title" content="ドラブラ2周年桜祭り" />
  <meta name="twitter:description" content="『ドラブラ2周年桜祭り』モザイクアート。ここに、かけがえのない思い出が集う。そしてーー、新たな出逢いが、ドラブラで始まる。" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://codedblood.jp/act/2020memo/img/share_all.jpg" />

  <title>ドラブラ2周年桜祭り</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XPJBS4ED8S"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-XPJBS4ED8S');
  </script>
  <script>
    var isMobile = false;
    if (
      navigator.userAgent.match(
        /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i
      )
    ) {
      isMobile = true;
    }
  </script>
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="swiper-bundle.min.css" />
</head>

<body>
  <div class="container" id="container">
    <div id="loading">
      <div class="loading_bg">
        <div class="circle"></div>
        <div class="num" id="loadingNum">0</div>
        <div class="txt"></div>
      </div>
    </div>
    <div id="video">
      <!-- <video src="img/v.mp4" width="100%" height="100%" autoplay></video> -->
    </div>
    <div id="anima">
      <div class="anima_v"></div>
    </div>
    <div id="main">
      <h1 class="sp logo">
        <a href="https://codedblood.jp/" target="_blank"><img src="img/logo.png" alt="" /></a>
      </h1>
      <div class="sp slogan">
        <img src="img/txt.png" alt="" />
      </div>
      <div class="canvas">
        <img src="./img/m.jpg" class="b" alt="" />
        <div class="topBar"></div>
        <div class="bottomBar"></div>

        <div class="main">
          <iframe id="mainFrame" src="./main.html" scrolling="no"></iframe>
        </div>
        <a href="#" target="_blank" class="sp share_top">
          <img class="pc" src="img/twitter_txt.png" alt="" />
          <img class="m" src="img/ico_twitter.png" alt="" />
          <!-- <span>モザイク看板をシェア</span> -->
        </a>
        <a href="https://codedblood.jp/act/2020memo/img/BigImg.jpg" target="_blank" class="sp download">
          <img src="img/download.png" alt="" />
          <!-- <span>オリジナル画像を保存</span> -->
        </a>
      </div>
      <div class="bg">
        <img src="img/bg_repeat.jpg" width="100%" height="100%" class="bg2" alt="">
        <img src="img/bg_repeat2.jpg" width="100%" height="100%" class="bg3" alt="">
      </div>
      <div class="search">
        <div class="sp serachCon">
          <img class="b" src="img/searchbar.png" alt="" />
          <input type="text" autocomplete="off" id="search" name="search" value="ツイッターID/ゲーム内ユーザー番号で検索"
            onblur="if(this.value=='')this.value='ツイッターID/ゲーム内ユーザー番号で検索'"
            onfocus="if(this.value=='ツイッターID/ゲーム内ユーザー番号で検索')this.value=''" />
          <div class="sp search_btn"></div>
        </div>
        <a href="#" class="sp random" id="randomBtn">
          <img src="img/random_01.png" alt="" />
        </a>
        <p class="s_n">
          <a href="#" class="search_note">検索用のID/ユーザー番号とは？</a>
        </p>
      </div>
    </div>

    <div id="gallery">
      <div class="mask"></div>
      <a href="#" class="sp close"></a>
      <div class="sp con">
        <div class="title">
          <div class="sp author">
            <strong></strong>
            <span class="note">
              合計 <span class="galleryNum"></span> 図が含まれています
            </span>
          </div>
        </div>
        <a href="#" class="leftArrg"></a>
        <div class="box swiper-container galleryPics">
          <div class="swiper-wrapper gallerySlides"></div>
          <div class="swiper-pagination"></div>
        </div>
        <a href="#" class="rightArrg"></a>
        <a href="#" target="_blank" class="share shareGallery">
          <span class="ico"></span>
          <span class="t">この作品をシェア</span>
        </a>
        <a href="#" class="heart">
          <span class="ico">
            <i></i>
          </span>
          <span class="num">0</span>
          <span class="note">「いいね」しました！</span>
        </a>

        <div class="thumbs">
          <a href="#" class="sp leftArr thumbsLeft"></a>
          <div class="thumbsCon swiper-container">
            <div class="swiper-wrapper gallerySlides"></div>
          </div>
          <a href="#" class="sp rightArr thumbsRight"></a>
        </div>
      </div>
      <a href="#" class="leftArrg"></a>
      <a href="#" class="rightArrg"></a>
    </div>
    <div id="alert">
      <div class="mask"></div>
      <a href="#" class="sp close"></a>
      <div class="box">
        <h2><img src="img/alert_t.png" alt="" /></h2>
        <div>
          <div style='text-align:left;width: 90%;margin: 0 auto;'>
            <p>ここに皆さんが「 #ドラブラアイドル」「 #思い出大作戦」「 #ドラブラメモリアル」に投稿してくれた作品を掲載しております。</p>
            <p>検索方法：ツイッターで投稿する場合、ツイッターID（＠XXX、「＠」後の部分のみで検索）で作品の掲載状況をチェックしてください。</p>
            <p>※イベント投稿後IDが変更された場合、旧IDで検索をお試してください。</p>
            <p>※一部のハッシュタグが反応しない、もしくは元のツイートが削除された場合、作品は収録できかねます。予めご了承ください。</p>
          </div>
        </div>
      </div>
    </div>
    <div class="copyright">
      COPYRIGHT © 1998 - 2021 TENCENT. ALL RIGHTS RESERVED.
    </div>
  </div>
  <!-- <div id="rotate">
    <div class="mask"></div>
  </div> -->
  <div class="hnote">
    <img src="img/hnote.jpg" alt="">
  </div>
  <script src="js/jquery-1.6.4.min.js"></script>
  <script src="data.js"></script>
  <script src="swiper-bundle.min.js"></script>
  <script>
    if (isMobile) {
      var detectOrient = function () {
        var width = document.documentElement.clientWidth,
          height = document.documentElement.clientHeight,
          $wrapper = document.getElementById("container"),
          style = "";
        if (width >= height) {
          style += "width:100%";
          style += "height:100%";
          style += "-webkit-transform: rotate(0); transform: rotate(0);";
          style += "-webkit-transform-origin: 0 0;";
          style += "transform-origin: 0 0;";
          //document.getElementById('rotate').style.display = 'none'
          $('.hnote').hide();
          $("#gallery .con").css({ "transform": "translate(-50%, -50%)" });
          $("#gallery .rightArrg,#gallery .leftArrg").css({ "top": "40%" })
        } else {
          style += "width:" + height + "px;";
          style += "height:" + width + "px;";
          style +=
            "-webkit-transform: rotate(90deg); transform: rotate(90deg);";
          style +=
            "-webkit-transform-origin: " +
            width / 2 +
            "px " +
            width / 2 +
            "px;";
          style +=
            "transform-origin: " + width / 2 + "px " + width / 2 + "px;";
          //document.getElementById('rotate').style.display = 'block'
          $('.hnote').show();
          $("#gallery .con").css({ "transform": "translate(-50%, -50%) scale(0.6)" });
          $("#gallery .rightArrg,#gallery .leftArrg").css({ "top": "47.5%" })
        }
        //$wrapper.style.cssText = style;
      };
      //window.addEventListener("onorientationchange" in window ? "orientationchange" : "resize",detectOrient)
      window.onresize = detectOrient;
      detectOrient();
      $('.container').addClass("mobile");
      $(".copyright").hide();
      $(".slogan img").attr("src", "img/txt_m.png");
    }
    $(function () {

      pageLoader();
      function setMainCon() {
        var html = "";
        for (var i = 0; i < 1250; i++) {
          html += "<div></div>";
        }
        $(".main").append(html);
        $(".main div").each(function (index) {
          $(this).click(function () {
            var r = Math.floor(index * 4.71);
            showRandomGallery(r);
            return false;
          });
        });

      }
      //setMainCon();
      $(".search_note").click(function () {
        showAlert();
        return false;
      });

      $(".search_btn").click(function () {
        searchGalleryById()
        return false;
      });

      $(document).delegate("div.tb span", "click", function () {
        console.log($(this).data("id"));
        searchGalleryById($(this).data("id"));
        return false;

      });
    });

    function searchGalleryById(param, index) {
      var id = param ? (param + '') : $("#search").val();
      id = id.replace(/(^\s*)|(\s*$)/g, "")
      if (!id) {
        return showAlert("ツイッターID/ゲーム内ユーザー番号で検索");
      }
      console.log(id);
      console.log(gallerysObj[id]);
      if (gallerysObj[id]) {
        setGallery(id, index || 0);
      } else {
        showAlert("<p style='padding-top:28%'>あなた作品が収録されていないようです (｡>﹏<｡)<p>");
      }
    }
    function checkURLParams() {
      if (window.location.search) {
        var id = getQueryVariable('id')
        if (id) {
          var index = getQueryVariable('index')
          searchGalleryById(id, index)
        }


      }
    }
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) {
          return pair[1];
        }
      }
      return false;
    }

    function pageLoader() {
      var imgPath = "./img/";
      var sourceArr = [
        "alert_t.png",
        "bg.jpg",
        "bg_repeat.jpg",
        "bottom_bar.png",
        "close.png",
        "download.png",
        "heart.png",
        "left_arr.png",
        "left_arr_shadow.png",
        "left_arr_shadow_large.png",
        "logo.png",
        "m.jpg",
        "mask.png",
        "popbox.png",
        "popbox2.png",
        "pop_bar.png",
        "pop_box.png",
        "random_txt.png",
        "right_arr.png",
        "right_arr_shadow.png",
        "right_arr_shadow_large.png",
        "search.png",
        "searchbar.png",
        "share.png",
        "tb.png",
        "top_bar.png",
        "twitter.png",
        "txt.png",
        "twitter_txt.png",
        "random_01.png",
        "random_02.png"
      ];
      if (isMobile) {
        sourceArr = [
          "alert_t.png",
          "bg.jpg",
          "bg_repeat.jpg",
          "bottom_bar.png",
          "close.png",
          "download.png",
          "heart.png",
          "left_m.png",
          "popbox2.png",
          "logo.png",
          "m.jpg",
          "mask.png",
          "popbox.png",
          "pop_bar_m.png",
          "alert_m.png",
          "random_txt.png",
          "right_m.png",
          "searchbar_m.png",
          "ico_twitter.png",
          "tb.png",
          "top_bar.png",
          "twitter.png",
          "txt_m.png",
          "m_video.jpg",
          "twitter_txt.png",
          "random_01.png",
          "random_02.png"
        ];
      }
      for (var i = 0; i < sourceArr.length; i++) {
        sourceArr[i] = imgPath + sourceArr[i];
      }
      var loadImage = function (path, callback) {
        var img = new Image();
        img.onload = function () {
          img.onload = null;
          callback(path);
        };
        img.src = path;
      };
      var imgLoader = function (imgs, callback) {
        var len = imgs.length,
          i = 0;
        while (imgs.length) {
          loadImage(imgs.shift(), function (path) {
            callback(path, ++i, len);
          });
        }
      };
      imgLoader(sourceArr, function (path, curNum, total) {
        var percent = curNum / total;
        var p = isMobile ? 100 : 70;
        document.getElementById("loadingNum").innerHTML = parseInt(
          percent * p
        );
        if (percent == 1) {
          //setTimeout(showMain, 500);
          if (isMobile) {
            $("#anima").fadeIn();
            $(".anima_v").one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
              $("#anima").hide();
            });
            setTimeout(() => {
              showMain('#loading');
            }, 500);
          } else {
            loadVideo(imgPath + "v.mp4");
          }
        }
      });
    }

    function loadVideo(src) {
      const req = new XMLHttpRequest();
      req.open("GET", src, true);
      req.responseType = "blob";
      req.onload = function () {
        if (this.status === 200) {
          const videoBlob = this.response;
          const blobSrc = URL.createObjectURL(videoBlob);
          console.log(blobSrc, "blobSrc加载完毕");
          document.getElementById("loadingNum").innerHTML = 100;
          setTimeout(showVideo, 500);
        }
      };
      req.onerror = function (e) {
        console.log("loadVideoErr", e);
      };
      req.send();
    }
    function showVideo() {
      $("#video").html(
        '<video id="v" src="img/v.mp4" muted="muted" width="100%" height="100%" autoplay></video>'
      );
      //return showMain('#loading')
      $("#video").fadeIn();
      $("#loading").fadeOut();
      document.getElementById("v").play();
      setTimeout(() => {
        showMain('#video')
      }, 4500);
    }
    function showMain(from) {
      $(from).fadeOut();
      $("#main").fadeIn(function () {
        checkURLParams()
        // document.getElementById("mainFrame").contentWindow.start();
        $(".random").click(function () {
          var r = Math.floor(Math.random() * gallerys.length);
          showRandomGallery(r);
          return false;
        });
      });
    }
    function showPop(pop, fn) {
      $(pop).fadeIn();
      $(pop + " .close").unbind("click");
      $(pop + " .close").bind("click", function () {
        $(pop).fadeOut();
        fn && fn();
        return false;
      });
    }
    function showAlert(msg) {
      $("#alert h2").hide();
      if (!msg) {
        $("#alert h2").show();
        msg =
          "<div style='text-align:left;width: 90%;margin: 0 auto;'><p>ここに皆さんが「 #ドラブラアイドル」「 #思い出大作戦」「 #ドラブラメモリアル」に投稿してくれた作品を掲載しております。</p><p>検索方法：ツイッターで投稿する場合、ツイッターID（＠XXX、「＠」後の部分のみで検索）で作品の掲載状況をチェックしてください。</p><p>※イベント投稿後IDが変更された場合、旧IDで検索をお試してください。</p><p>※一部のハッシュタグが反応しない、もしくは元のツイートが削除された場合、作品は収録できかねます。予めご了承ください。</p></div>";
      }
      $("#alert .box div").html(msg);
      showPop("#alert");
    }
    function showRandomGallery(r) {
      showPop("#gallery", function () {
        $("#search").val("ツイッターID/ゲーム内ユーザー番号で検索");
      });
      console.log(r);
      randomGallery(r);
    }
    var picBase = "https://www.codedblood.jp/act/a2022pic/omoide/images/";
    var galleryThumbs;
    var galleryPics;
    function randomGallery(index) {
      if (galleryThumbs) galleryThumbs.destroy();
      if (galleryPics) galleryPics.destroy();
      $("#gallery .thumbs, #gallery .title").hide();
      $("#gallery .leftArrg, #gallery .rightArrg").show();
      $(".gallerySlides").empty();
      galleryPics = new Swiper(".galleryPics", {
        lazy: {
          loadPrevNext: true,
        },
        virtual: {
          slides: (function () {
            var slides = [];
            for (var i = 0; i < gallerys.length; i += 1) {
              var charaName = charaNames[gallerys[i].id] ? charaNames[gallerys[i].id] : gallerys[i].id
              slides.push(
                '<div class="swiper-slide"><img data-src="'+(picBase+gallerys[i].url)+'" class="swiper-lazy" /><div class="swiper-lazy-preloader swiper-lazy-preloader-white"></div><div class="tb"><span data-id="' +
                gallerys[i].id +
                '">@' +
                charaName +
                "</span></div></div>"
              );
            }
            return slides;
          })(),
        },
        spaceBetween: 0,
        navigation: {
          nextEl: ".rightArrg",
          prevEl: ".leftArrg",
        },
        on: {
          slideChangeTransitionStart: function () {
            $("#gallery .share, #gallery .heart").hide();
          },
          slideChangeTransitionEnd: function () {
            console.log('random:transend:')
            getLikeByIndex(this.activeIndex + 1);
          }
        },
      });
      $(".gallerySlides").unbind("click");

      getLikeByIndex(index + 1);
      galleryPics.slideTo(index, 0);
    }

    function setGallery(id, gIndex) {
      $("#gallery .thumbs, #gallery .title").show();
      $("#gallery .leftArrg, #gallery .rightArrg").hide();
      showPop("#gallery", function () {
        $("#search").val("ツイッターID/ゲーム内ユーザー番号で検索");
      });
      if (galleryThumbs) galleryThumbs.destroy();
      if (galleryPics) galleryPics.destroy();
      var g = gallerysObj[id];
      var charaName = charaNames[id] ? charaNames[id] : id
      $("#gallery .title .author strong").text("@" + charaName);
      var len = g.pics.length;
      $("#gallery .galleryNum").text(len);
      $(".gallerySlides").empty();
      var html = "";
      for (var i = 0; i < len; i++) {
        html +=
          '<div class="swiper-slide"><img data-src="' +
          (picBase + g.pics[i].url) +
          '" class="swiper-lazy" /><div class="swiper-lazy-preloader swiper-lazy-preloader-white"></div></div>';
      }
      $(".gallerySlides").append(html);
      if (len < 5) {
        $(".thumbsRight,.thumbsLeft").hide();
      } else {
        $(".thumbsRight,.thumbsLeft").show();
      }
      galleryThumbs = new Swiper(".thumbsCon", {
        lazy: {
          loadPrevNext: true,
        },
        spaceBetween: 10,
        slidesPerView: 5,
        freeMode: true,
        watchSlidesVisibility: true,
        watchSlidesProgress: true,
      });
      var gParams = {
        width: isMobile ? 439 : $("#gallery .box").width(),
        lazy: {
          loadPrevNext: true,
        },
        spaceBetween: 0,
        navigation: isMobile
          ? {
            nextEl: ".rightArrg",
            prevEl: ".leftArrg",
          }
          : {
            nextEl: ".thumbsRight",
            prevEl: ".thumbsLeft",
          },
        on: {
          slideChangeTransitionStart: function () {
            $("#gallery .share, #gallery .heart").hide();
          },
          slideChangeTransitionEnd: function () {
            getLikeByIndex(g.pics[this.activeIndex].index, this.activeIndex);
          }
        },
      };
      if (isMobile) {
        $("#gallery .leftArrg, #gallery .rightArrg").show();
        gParams.pagination = {
          el: "#gallery .box .swiper-pagination",
        };
      } else {
        gParams.thumbs = {
          swiper: galleryThumbs,
        };
      }
      galleryPics = new Swiper(".galleryPics", gParams);
      if (gIndex) {
        galleryPics.slideTo(gIndex);
        getLikeByIndex(g.pics[gIndex].index, gIndex);
      } else {
        galleryPics.slideTo(0);
        getLikeByIndex(g.pics[0].index);
      }
    }
    function getPicIndexByUrl(id, url) {
      var pics = gallerysObj[id].pics;
      var index = pics.findIndex(p => p.url == url)
      return index !== -1 ? index : 0
    }
    function getLikeByIndex(index, gId) {
      var gItem = gallerys[index - 1];
      var gIndex = gId === 0 ? 0 : getPicIndexByUrl(gItem.id, gItem.url);
      //动态
      setShare('.shareGallery', {
        id: gItem.id,
        index: gIndex,
        text: '素敵な作品に出会えてよかった。写真映えならやっぱり #ドラブラ。みんなもぜひチェックしてみてね！看板や作品をシェアすると記念画集が当たるチャンス！',
        img: gItem.url
      })
      $.ajax({
        type: "GET",
        url:
          "https://sg.apps.game.qq.com/swoole/module.php?actid=1852&r=index/init&imgID=" +
          index +
          "&responsetype=1",
        success: function (result) {
          // console.log(result);
          result = JSON.parse(result);
          if (result.jData.code == 0) {
            $(".heart .num").text(result.jData.data.good);
            $("#gallery .share, #gallery .heart").fadeIn();
            setHeartBtn(result.jData.data.good, index);
          } else {
            setTimeout(function () {
              getLikeByIndex(index, gId);
            }, 1000);
          }
        },
        error: function (e) {
          console.log("getErr:", index, e);
          setTimeout(function () {
            getLikeByIndex(index, gId);
          }, 1000);
        },
      });
    }
    ///
    var n = 0;
    var txtlist = [
      "「いいね」しました！",
      "「いいね」2回目成功！",
      "頑張れ！",
      "ありがとうございます！",
      "素敵な作品ですね。",
      "「いいね」ありがとうございます！",
      "新年に「いいね」をたくさんもらえることを願っています。",
      "...実は、「いいね」できる回数に制限がないのです！",
      "「いいね」は、好きなだけ押せますよ〜！",
    ];
    function setHeartBtn(likeNum, index) {
      var h = likeNum || 0;
      $(".heart .num").text(h);
      $(".heart .note").hide();
      $(".heart .ico").addClass("move");
      var liking = false;
      $(".heart .ico").unbind("click");
      $(".heart .ico").click(function () {
        $(".heart .note").hide();
        if (liking) return false;
        liking = true;
        $(this).addClass("like");
        $(this).removeClass("move");
        doLike(index);
        n++;
        if (n == 1) {
          $(".heart .note").text(txtlist[0]);
        } else if (n == 2) {
          $(".heart .note").text(txtlist[1]);
        } else if (n > 2) {
          var ran = Math.floor(Math.random() * (2 - 8 + 1) + 8);
          console.log(ran);
          $(".heart .note").text(txtlist[ran]);
        }
        ////
        setTimeout(() => {
          $(this).removeClass("like");
          $(".heart .num").text(++h);
          $(".heart .note").fadeIn(
            function () {
              setTimeout(function () {
                $(".heart .note").fadeOut()
                $(".heart .ico").addClass("move");
              }, 2000)
            }
          );
          liking = false;
        }, 1000);
        return false;
      });
    }
    function doLike(index) {
      $.ajax({
        type: "GET",
        url:
          "https://sg.apps.game.qq.com/swoole/module.php?actid=1852&r=index/good&imgID=" +
          index +
          "&responsetype=1",
        success: function (result) {
          result = JSON.parse(result);
          console.log(result);
          if (result.jData.code == 0) {
          } else {
            setTimeout(function () {
              doLike(index);
            }, 1000);
          }
        },
        error: function (e) {
          console.log("likeErr:", index, e);
          setTimeout(function () {
            doLike(index);
          }, 1000);
        },
      });
    }
    /////
    $("#randomBtn").hover(function () {
      $("#randomBtn img").attr("src", "img/random_02.png");
    }, function () {
      $("#randomBtn img").attr("src", "img/random_01.png");
    });
    //////////分享
    function setShare(target, params) {
      var shareBaseUrl = 'https://twitter.com/share'
      var url = 'https://actshare.amsoveasea.com/h5codedbloodjp.php';
      params = params || {}
      var image = params.img ? params.img : '';
      if (params.id) {
        url += '?id=' + params.id;
        if (params.index) {
          url += '&index=' + params.index + '&image=' + image
        }
      }
      //静态
      var text = params.text ? params.text : '『#ドラブラ 2020年の思い出』モザイクアート。ここに、かけがえのない思い出が集う。そしてーー、新たな出逢いが、ドラブラで始まる。看板や作品をシェアすると記念画集が当たるチャンス！';

      // $(target).attr('href','https://twitter.com/share?text='+encodeURIComponent(text) + '&url=' + encodeURIComponent(url) + '&image=')
      var shareUrl = shareBaseUrl + "?text=" + encodeURIComponent(text) + "&url=" + encodeURIComponent(url);
      $(target).attr('href', shareUrl)
    }
    setShare('.share_top')
  </script>
</body>

</html>